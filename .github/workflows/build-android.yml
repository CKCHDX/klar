name: Build Klar Android APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-apk:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.9
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git \
            wget \
            curl \
            unzip \
            build-essential \
            libffi-dev \
            libssl-dev

      - name: Download Android SDK
        run: |
          mkdir -p ~/android-sdk
          cd ~/android-sdk
          
          # Download Android SDK command-line tools
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
          unzip -q commandlinetools-linux-9477386_latest.zip
          
          # Setup SDK manager
          mkdir -p cmdline-tools/latest
          mv cmdline-tools/* cmdline-tools/latest/ 2>/dev/null || true
          
          export ANDROID_SDK_ROOT=~/android-sdk
          export ANDROID_HOME=~/android-sdk
          export PATH=$PATH:~/android-sdk/cmdline-tools/latest/bin
          
          # Accept licenses and install SDK components
          echo "y" | sdkmanager --sdk_root=$ANDROID_SDK_ROOT "platforms;android-33" 2>&1 | tail -20
          echo "y" | sdkmanager --sdk_root=$ANDROID_SDK_ROOT "build-tools;33.0.0" 2>&1 | tail -20
          echo "y" | sdkmanager --sdk_root=$ANDROID_SDK_ROOT "ndk;25.1.8937393" 2>&1 | tail -20
          
          echo "ANDROID_SDK_ROOT=~/android-sdk" >> $GITHUB_ENV
          echo "ANDROID_HOME=~/android-sdk" >> $GITHUB_ENV
          echo "PATH=$PATH:~/android-sdk/cmdline-tools/latest/bin" >> $GITHUB_ENV

      - name: Install p4a and build tools
        run: |
          pip install --upgrade pip
          pip install python-for-android==2024.03.13
          pip install cython==0.29.35

      - name: Verify tools
        run: |
          java -version
          p4a --version || echo "p4a check failed"

      - name: Build APK with p4a
        working-directory: lab
        run: |
          export ANDROID_SDK_ROOT=~/android-sdk
          export ANDROID_HOME=~/android-sdk
          export ANDROID_NDK_ROOT=~/android-sdk/ndk/25.1.8937393
          export JAVA_HOME=/usr/lib/jvm/temurin-11-jdk-amd64
          
          echo "Building APK..."
          p4a apk \
            --private . \
            --package=se.oscyra.klar \
            --name="Klar" \
            --version 3.0.0 \
            --bootstrap=webview \
            --requirements=python3,kivy,requests,beautifulsoup4 \
            --permission INTERNET \
            --permission ACCESS_NETWORK_STATE \
            --icon ../klar.ico \
            --release
        env:
          ANDROID_SDK_ROOT: ~/android-sdk
          ANDROID_HOME: ~/android-sdk
          ANDROID_NDK_ROOT: ~/android-sdk/ndk/25.1.8937393
          JAVA_HOME: /usr/lib/jvm/temurin-11-jdk-amd64

      - name: Find APK
        if: always()
        run: |
          echo "Searching for APK..."
          find ~ -name "*.apk" -type f 2>/dev/null | head -20

      - name: Upload APK
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: klar-apk
          path: "**/*.apk"
          if-no-files-found: warn
