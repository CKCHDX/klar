name: Build Klar Android APK

on:
  push:
    branches: [ main ]
    paths:
      - 'lab/**'
      - '.github/workflows/build-android.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'lab/**'
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Copy project files to lab directory
      run: |
        # Copy core files to lab
        cp keywords_db.json lab/ || echo "keywords_db.json not found"
        cp domains.json lab/ || echo "domains.json not found"
        cp klar.ico lab/ || echo "klar.ico not found"
        
        # Copy engine directory
        if [ -d "engine" ]; then
          cp -r engine lab/
        else
          echo "Warning: engine directory not found"
        fi
        
        # Copy algorithms if exists
        if [ -d "algorithms" ]; then
          cp -r algorithms lab/
        fi
        
        # Copy core if exists  
        if [ -d "core" ]; then
          cp -r core lab/
        fi
        
        # List lab contents
        echo "Lab directory contents:"
        ls -la lab/
    
    - name: Build APK with Buildozer
      uses: ArtemSBulgakov/buildozer-action@v1
      id: buildozer
      with:
        workdir: lab
        buildozer_version: stable
    
    - name: Find and organize APK
      run: |
        # Create output directory
        mkdir -p release/android
        
        # Find the built APK
        APK_FILE=$(find lab/.buildozer -name "*.apk" -type f | head -n 1)
        
        if [ -z "$APK_FILE" ]; then
          echo "Error: No APK file found!"
          echo "Searching for APK files:"
          find lab -name "*.apk" -type f || echo "No APK files found anywhere"
          exit 1
        fi
        
        echo "Found APK: $APK_FILE"
        
        # Copy and rename APK
        cp "$APK_FILE" release/android/Klar-3.0-debug.apk
        
        echo "APK copied to release/android/"
        ls -lh release/android/
    
    - name: Create Android README
      run: |
        cat > release/android/README.md << 'EOF'
        # Klar 3.0 - Android APK

        ## Installation

        1. Download `Klar-3.0-debug.apk`
        2. Enable "Install from Unknown Sources" in Android settings:
           - Settings â†’ Security â†’ Unknown Sources (enable)
           - OR Settings â†’ Apps â†’ Special Access â†’ Install Unknown Apps
        3. Open the downloaded APK file and tap Install
        4. Launch Klar from your app drawer

        ## Features

        - Native Android app (Python-powered with Kivy)
        - 111 Swedish domains built-in
        - 700+ Swedish keywords database
        - Dark mode Material Design interface
        - Touch-optimized for mobile
        - No tracking, no ads, no bloat
        - Works completely offline (database embedded)

        ## System Requirements

        - Android 5.0 (Lollipop) or higher
        - ~100MB storage space
        - Internet connection for web searches

        ## First Launch

        The app may take 10-20 seconds to start on first launch while
        it extracts and initializes the Python runtime. Subsequent 
        launches will be much faster (2-3 seconds).

        ## Technical Details

        - Built with: Python 3.11 + Kivy + KivyMD
        - Package: se.oscyra.klar
        - Version: 3.0.0
        - Architecture: ARM64-v8a + ARMv7a (universal)
        - Min SDK: 21 (Android 5.0)
        - Target SDK: 33 (Android 13)

        ## Note

        This is a DEBUG build for testing purposes. It is not signed 
        for production distribution via Google Play Store.

        ## Support & Source Code

        https://github.com/CKCHDX/klar
        EOF
    
    - name: Generate APK checksum
      working-directory: ./release/android
      run: |
        sha256sum Klar-3.0-debug.apk > Klar-3.0-debug.apk.sha256
        echo "SHA256:"
        cat Klar-3.0-debug.apk.sha256
    
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: Klar-Android-APK
        path: |
          release/android/Klar-3.0-debug.apk
          release/android/README.md
          release/android/Klar-3.0-debug.apk.sha256
        retention-days: 90
    
    - name: Build summary
      run: |
        APK_SIZE=$(du -h release/android/Klar-3.0-debug.apk | cut -f1)
        echo "## ðŸŽ‰ Android Build Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“± APK Details" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
        echo "| -------- | ----- |" >> $GITHUB_STEP_SUMMARY
        echo "| **File** | Klar-3.0-debug.apk |" >> $GITHUB_STEP_SUMMARY
        echo "| **Size** | $APK_SIZE |" >> $GITHUB_STEP_SUMMARY
        echo "| **Architecture** | ARM64-v8a + ARMv7a |" >> $GITHUB_STEP_SUMMARY
        echo "| **Min Android** | 5.0 (API 21) |" >> $GITHUB_STEP_SUMMARY
        echo "| **Target Android** | 13 (API 33) |" >> $GITHUB_STEP_SUMMARY
        echo "| **Package** | se.oscyra.klar |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¥ Download" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Download the APK from the **Artifacts** section at the bottom of this page." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ” SHA256 Checksum" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        cat release/android/Klar-3.0-debug.apk.sha256 >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
