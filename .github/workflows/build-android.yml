name: Build Klar Android APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    container:
      image: kivy/buildozer:latest
      options: --user root

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Build Environment
        run: |
          echo "=== Build Environment ==="
          python --version
          buildozer --version
          java -version
          echo ""
          echo "=== Preparing workspace ==="
          mkdir -p /tmp/klar_build
          cd /tmp/klar_build
          cp -r $GITHUB_WORKSPACE/lab .
          cp $GITHUB_WORKSPACE/keywords_db.json . 2>/dev/null || echo "keywords_db.json not found"
          cp $GITHUB_WORKSPACE/domains.json . 2>/dev/null || echo "domains.json not found"
          cp -r $GITHUB_WORKSPACE/engine . 2>/dev/null || echo "engine not found"
          echo "Workspace ready:"
          ls -la /tmp/klar_build/
          echo ""
          echo "Lab contents:"
          ls -la /tmp/klar_build/lab/

      - name: Build APK
        working-directory: /tmp/klar_build/lab
        run: |
          set -e
          echo "=== Starting Buildozer ==="
          echo "Current directory: $(pwd)"
          echo "Files:"
          ls -la
          echo ""
          
          # Run buildozer with verbose output
          buildozer -v android debug 2>&1 | tee build.log
          
          BUILD_STATUS=${PIPESTATUS[0]}
          
          if [ $BUILD_STATUS -eq 0 ]; then
            echo ""
            echo "✓ Build completed"
          else
            echo ""
            echo "✗ Build failed with code $BUILD_STATUS"
            echo ""
            echo "=== Last 200 lines of build log ==="
            tail -n 200 build.log
          fi
          
          exit $BUILD_STATUS
        env:
          USER: root
          HOME: /root

      - name: Check For APK
        if: always()
        working-directory: /tmp/klar_build/lab
        run: |
          echo "=== Searching for APK files ==="
          find . -name "*.apk" -type f
          
          echo ""
          echo "=== Checking bin directory ==="
          if [ -d bin ]; then
            echo "bin directory contents:"
            ls -lh bin/
          else
            echo "bin directory does not exist"
          fi
          
          echo ""
          echo "=== Full directory structure ==="
          find . -maxdepth 3 -type d | head -20

      - name: Upload APK
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: klar-android-apk
          path: /tmp/klar_build/lab/bin/*.apk
          retention-days: 30

      - name: Upload Logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: /tmp/klar_build/lab/build.log
          retention-days: 7
