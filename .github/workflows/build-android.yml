name: Build Klar Android APK (Manual)

on:
  push:
    branches: [ main ]
    paths:
      - 'lab/**'
      - '.github/workflows/build-android.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'lab/**'
  workflow_dispatch:

jobs:
  build-android-manual:
    runs-on: ubuntu-latest

    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v4

      - name: 2. Prepare Build Workspace
        run: |
          echo "Creating isolated build directory..."
          mkdir build_workspace
          
          # Copy source code from lab
          echo "Copying lab files..."
          if [ -d "lab" ]; then
             cp -v lab/* build_workspace/
          else
             echo "ERROR: 'lab' directory not found."
             exit 1
          fi
          
          # Copy assets from root
          echo "Copying assets..."
          [ -f keywords_db.json ] && cp -v keywords_db.json build_workspace/
          [ -f domains.json ] && cp -v domains.json build_workspace/
          [ -f klar.ico ] && cp -v klar.ico build_workspace/
          
          # Copy engine package
          if [ -d "engine" ]; then
            echo "Copying engine module..."
            cp -r engine build_workspace/
          fi

          echo "Workspace contents:"
          ls -R build_workspace/

      - name: 3. Setup Python 3.9
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: 4. Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            git \
            python3-pip \
            python3-setuptools \
            libffi-dev \
            libssl-dev \
            autoconf \
            libtool \
            pkg-config \
            zlib1g-dev \
            openjdk-17-jdk \
            unzip \
            zip \
            libncurses5-dev \
            libncursesw5-dev \
            cmake gettext

      - name: 5. Install Buildozer & Dependencies
        run: |
          pip install --upgrade pip
          pip install --upgrade setuptools wheel
          # Using specific versions known to be stable
          pip install "buildozer==1.5.0" "cython==0.29.36"
          
          echo "Buildozer version:"
          buildozer --version

      - name: 6. Build APK (Step-by-Step)
        working-directory: build_workspace
        run: |
          # Add local bin to path to find buildozer
          export PATH=$PATH:$HOME/.local/bin
          
          echo "Starting Buildozer..."
          # The 'yes' command automatically accepts the SDK license agreement prompts
          yes | buildozer -v android debug
        env:
          # Explicitly set USER to fix permission issues seen in previous runs
          USER: runner
          HOME: /home/runner

      - name: 7. Upload APK Artifact
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: Klar-Android-APK
          path: build_workspace/bin/*.apk

      - name: 8. Upload Build Logs (On Failure)
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: build-failure-logs
          path: |
            build_workspace/.buildozer/android/platform/build-*/dists/*/build.log
