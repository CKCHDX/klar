name: Build Klar Release

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allows manual trigger from Actions tab

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install PyQt6 PyQt6-WebEngine requests beautifulsoup4 lxml pyinstaller pillow
    
    - name: Verify file integrity
      run: |
        python -c "import json; json.load(open('keywords_db.json', encoding='utf-8'))"
        python -c "import json; json.load(open('domains.json', encoding='utf-8'))"
        python -m py_compile klar_browser.py
    
    - name: Build with PyInstaller
      run: |
        pyinstaller --onefile --windowed --name Klar --icon klar.ico --add-data "keywords_db.json;." --add-data "domains.json;." --add-data "engine;engine" --hidden-import PyQt6.QtCore --hidden-import PyQt6.QtGui --hidden-import PyQt6.QtWidgets --hidden-import PyQt6.QtWebEngineWidgets --hidden-import PyQt6.QtWebEngineCore --hidden-import requests --hidden-import bs4 --hidden-import lxml klar_browser.py
    
    - name: Create release structure
      run: |
        mkdir release
        mkdir release\windows
        copy dist\Klar.exe release\windows\Klar.exe
        echo ============================================ > release\windows\README.txt
        echo   Klar 3.0 - Swedish Browser >> release\windows\README.txt
        echo ============================================ >> release\windows\README.txt
        echo. >> release\windows\README.txt
        echo STANDALONE SINGLE-FILE EXECUTABLE >> release\windows\README.txt
        echo No installation required! >> release\windows\README.txt
        echo. >> release\windows\README.txt
        echo Installation: >> release\windows\README.txt
        echo   1. Just run Klar.exe >> release\windows\README.txt
        echo   2. That's it! >> release\windows\README.txt
        echo. >> release\windows\README.txt
        echo System Requirements: >> release\windows\README.txt
        echo   - Windows 10 or Windows 11 >> release\windows\README.txt
        echo   - 4GB RAM minimum >> release\windows\README.txt
        echo   - Internet connection for searches >> release\windows\README.txt
        echo. >> release\windows\README.txt
        echo Features: >> release\windows\README.txt
        echo   - 111 Swedish domains >> release\windows\README.txt
        echo   - 700+ keywords >> release\windows\README.txt
        echo   - No tracking or ads >> release\windows\README.txt
        echo   - Fast search engine >> release\windows\README.txt
        echo   - Dark mode interface >> release\windows\README.txt
        echo. >> release\windows\README.txt
        echo Support: >> release\windows\README.txt
        echo   https://github.com/CKCHDX/klar >> release\windows\README.txt
    
    - name: Generate checksum
      run: |
        cd release\windows
        certutil -hashfile Klar.exe SHA256 > Klar.SHA256.txt
    
    - name: Upload Windows executable
      uses: actions/upload-artifact@v4
      with:
        name: Klar-Windows-Standalone
        path: |
          release/windows/Klar.exe
          release/windows/README.txt
          release/windows/Klar.SHA256.txt
        retention-days: 90
    
    - name: Create Release ZIP
      run: |
        Compress-Archive -Path release\windows\* -DestinationPath Klar-Windows-Standalone.zip
    
    - name: Upload Release ZIP
      uses: actions/upload-artifact@v4
      with:
        name: Klar-Windows-ZIP
        path: Klar-Windows-Standalone.zip
        retention-days: 90

  build-linux:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libxcb-xinerama0 libxcb-cursor0 libxkbcommon-x11-0 libgl1-mesa-dev
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install PyQt6 PyQt6-WebEngine requests beautifulsoup4 lxml pyinstaller pillow
    
    - name: Build with PyInstaller
      run: |
        pyinstaller --onefile --windowed --name Klar --add-data "keywords_db.json:." --add-data "domains.json:." --add-data "engine:engine" --hidden-import PyQt6.QtCore --hidden-import PyQt6.QtGui --hidden-import PyQt6.QtWidgets --hidden-import PyQt6.QtWebEngineWidgets --hidden-import PyQt6.QtWebEngineCore --hidden-import requests --hidden-import bs4 --hidden-import lxml klar_browser.py
    
    - name: Create Linux README
      run: |
        mkdir -p release/linux
        cp dist/Klar release/linux/
        cat > release/linux/README.md << 'EOF'
        # Klar 3.0 - Swedish Browser (Linux)

        ## Standalone Executable

        This is a single-file executable with all dependencies embedded.

        ## Installation

        1. Make executable: `chmod +x Klar`
        2. Run: `./Klar`

        ## System Requirements

        - Ubuntu 20.04+ / Debian 11+ / Fedora 35+
        - 4GB RAM minimum
        - X11 or Wayland display server

        ## Features

        - 111 Swedish domains
        - 700+ keywords
        - No tracking or ads
        - Fast search engine
        - Dark mode interface

        ## Support

        https://github.com/CKCHDX/klar
        EOF
    
    - name: Generate checksum
      run: |
        cd release/linux
        sha256sum Klar > Klar.SHA256.txt
    
    - name: Upload Linux executable
      uses: actions/upload-artifact@v4
      with:
        name: Klar-Linux-Standalone
        path: |
          release/linux/Klar
          release/linux/README.md
          release/linux/Klar.SHA256.txt
        retention-days: 90
    
    - name: Create Release TAR.GZ
      run: |
        cd release/linux
        tar -czf ../../Klar-Linux-Standalone.tar.gz Klar README.md Klar.SHA256.txt
    
    - name: Upload Release TAR.GZ
      uses: actions/upload-artifact@v4
      with:
        name: Klar-Linux-TAR
        path: Klar-Linux-Standalone.tar.gz
        retention-days: 90
