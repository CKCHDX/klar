name: Build Klar 3.1 Release

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'lab/**'
      - 'docs/**'
      - '*.md'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - 'lab/**'
      - 'docs/**'
      - '*.md'
  workflow_dispatch:  # Allows manual trigger from Actions tab

jobs:
  verify:
    name: Verify Build Requirements
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Verify JSON files
      run: |
        python -c "import json; data = json.load(open('keywords_db.json', encoding='utf-8')); print(f'Keywords DB: {len(data.get(\"mappings\", {}))} categories')"
        python -c "import json; data = json.load(open('domains.json', encoding='utf-8')); print(f'Domains: {len(data)} whitelisted domains')"
    
    - name: Verify Python syntax
      run: |
        python -m py_compile klar_browser.py
        python -m py_compile engine/search_engine.py
        python -m py_compile engine/domain_whitelist.py
        python -m py_compile core/crawler.py
        python -m py_compile algorithms/sven.py
        python -m py_compile algorithms/thor.py
    
    - name: Check dependencies
      run: |
        python -m pip install --upgrade pip
        pip install PyQt6 PyQt6-WebEngine requests beautifulsoup4 lxml pillow
        python -c "import PyQt6; import PyQt6.QtWebEngineWidgets; import requests; import bs4; print('All dependencies available')"

  build-windows:
    name: Build Windows Executable
    needs: verify
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install PyQt6 PyQt6-WebEngine requests beautifulsoup4 lxml pyinstaller pillow
    
    - name: Build with PyInstaller
      run: |
        pyinstaller --onefile --windowed --name Klar --icon klar.ico `
          --add-data "keywords_db.json;." `
          --add-data "domains.json;." `
          --add-data "engine;engine" `
          --add-data "algorithms;algorithms" `
          --add-data "core;core" `
          --hidden-import PyQt6.QtCore `
          --hidden-import PyQt6.QtGui `
          --hidden-import PyQt6.QtWidgets `
          --hidden-import PyQt6.QtWebEngineWidgets `
          --hidden-import PyQt6.QtWebEngineCore `
          --hidden-import requests `
          --hidden-import bs4 `
          --hidden-import lxml `
          klar_browser.py
    
    - name: Verify executable
      run: |
        if (Test-Path dist/Klar.exe) {
          Write-Host "âœ“ Executable created successfully"
          Get-Item dist/Klar.exe | Select-Object Length
        } else {
          throw "Executable not found"
        }
    
    - name: Create Windows Release Package
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path release/windows | Out-Null
        Copy-Item dist/Klar.exe release/windows/Klar.exe
        
        $buildDate = Get-Date -Format 'yyyy-MM-dd HH:mm:ss'
        $readme = @"
KLAR 3.1 - Official Swedish Search Engine
=========================================

VERSION: 3.1 (Beta)
BUILD DATE: $buildDate
TYPE: Windows Standalone Executable

ðŸš€ QUICK START
1. Run Klar.exe
2. Search for anything (no installation needed!)
3. That's it!

ðŸ“‹ SYSTEM REQUIREMENTS
- Windows 10 or Windows 11
- 4GB RAM minimum (8GB recommended)
- 200MB free disk space
- Internet connection for searches

âœ¨ FEATURES
âœ“ 115 Swedish whitelisted domains
âœ“ Deep search within domains (articles, products, guides)
âœ“ SVEN: Swedish Natural Language Processing
âœ“ THOR: Intelligent ranking algorithm
âœ“ Smart search URL generation per domain
âœ“ Wikipedia article direct links
âœ“ No tracking, no ads, no data collection
âœ“ Fast dark-mode interface
âœ“ Single-file executable (no installation)
âœ“ All dependencies included

ðŸ”’ SECURITY
âœ“ Only searches whitelisted Swedish domains
âœ“ No external browser plugins
âœ“ No telemetry or analytics
âœ“ Offline-ready (LOKI caching)

âš™ï¸ WHAT'S NEW IN 3.1
âœ“ FIXED: Domain whitelist security (now handles subdomains/subpages)
âœ“ NEW: Deep crawling of search results
âœ“ NEW: Smart search URLs per domain type
âœ“ NEW: Wikipedia API integration
âœ“ NEW: Result deduplication
âœ“ IMPROVED: Parallel crawling with 4 workers
âœ“ IMPROVED: Rate limiting (0.5s per domain)

ðŸ“– HOW TO USE
1. Type in the search bar
2. Klar finds results from 115 trusted domains
3. Subpages and articles appear automatically

EXAMPLES:
- "sverige nyheter" â†’ News articles from SVT, DN
- "hur bÃ¤ckar man fisk" â†’ Cooking guides
- "vem Ã¤r greta thunberg" â†’ Wikipedia article
- "mobil under 5000 kr" â†’ Product prices
- "vad Ã¤r diabetes" â†’ Health information from 1177.se

ðŸ”§ TROUBLESHOOTING
If it doesn't start:
- Try right-click â†’ "Run as Administrator"
- Check internet connection
- Make sure you have .NET Framework or Visual C++ installed

ðŸ’¬ SUPPORT
GitHub: https://github.com/CKCHDX/klar
Issues: https://github.com/CKCHDX/klar/issues
Contact: oscyra.solutions

ðŸ“„ LICENSE
Klar is free software. See LICENSE file for details.

â­ VERSION NOTES
- This is a BETA release
- Report bugs to GitHub Issues
- Feedback is welcome!
"@
        
        Set-Content -Path release/windows/README.txt -Value $readme
    
    - name: Generate checksum
      shell: cmd
      run: |
        cd release\windows
        certutil -hashfile Klar.exe SHA256 > Klar.SHA256.txt
        type Klar.SHA256.txt
    
    - name: Upload Windows Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Klar-3.1-Windows-Standalone
        path: |
          release/windows/Klar.exe
          release/windows/README.txt
          release/windows/Klar.SHA256.txt
        retention-days: 90
    
    - name: Create Windows ZIP
      shell: pwsh
      run: |
        Compress-Archive -Path release/windows/* -DestinationPath Klar-3.1-Windows-Standalone.zip
        Get-Item Klar-3.1-Windows-Standalone.zip | Select-Object Length
    
    - name: Upload Windows ZIP
      uses: actions/upload-artifact@v4
      with:
        name: Klar-3.1-Windows-ZIP
        path: Klar-3.1-Windows-Standalone.zip
        retention-days: 90

  build-linux:
    name: Build Linux Executable
    needs: verify
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libxcb-xinerama0 libxcb-cursor0 libxkbcommon-x11-0 libgl1-mesa-dev libfontconfig1
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install PyQt6 PyQt6-WebEngine requests beautifulsoup4 lxml pyinstaller pillow
    
    - name: Build with PyInstaller
      run: |
        pyinstaller --onefile --windowed --name Klar \
          --add-data "keywords_db.json:." \
          --add-data "domains.json:." \
          --add-data "engine:engine" \
          --add-data "algorithms:algorithms" \
          --add-data "core:core" \
          --hidden-import PyQt6.QtCore \
          --hidden-import PyQt6.QtGui \
          --hidden-import PyQt6.QtWidgets \
          --hidden-import PyQt6.QtWebEngineWidgets \
          --hidden-import PyQt6.QtWebEngineCore \
          --hidden-import requests \
          --hidden-import bs4 \
          --hidden-import lxml \
          klar_browser.py
    
    - name: Verify executable
      run: |
        if [ -f dist/Klar ]; then
          echo "âœ“ Executable created successfully"
          ls -lh dist/Klar
        else
          echo "âœ— Executable not found"
          exit 1
        fi
    
    - name: Create Linux Release Package
      run: |
        mkdir -p release/linux
        cp dist/Klar release/linux/
        chmod +x release/linux/Klar
        
        cat > release/linux/README.md << 'EOF'
# Klar 3.1 - Official Swedish Search Engine (Linux)

**Version:** 3.1 (Beta)  
**Type:** Linux Standalone Executable

## ðŸš€ Quick Start

```bash
chmod +x Klar
./Klar
```

## ðŸ“‹ System Requirements

- Ubuntu 20.04+ / Debian 11+ / Fedora 35+
- 4GB RAM minimum (8GB recommended)
- 200MB free disk space
- X11 or Wayland display server
- Internet connection for searches

## âœ¨ Features

âœ“ 115 Swedish whitelisted domains
âœ“ Deep search within domains (articles, products, guides)
âœ“ SVEN: Swedish Natural Language Processing
âœ“ THOR: Intelligent ranking algorithm
âœ“ Wikipedia article direct links
âœ“ No tracking, no ads
âœ“ Fast dark-mode interface
âœ“ All dependencies included
âœ“ Single executable (no installation needed)

## ðŸ”’ Security

âœ“ Only searches whitelisted Swedish domains
âœ“ No external browser plugins
âœ“ No telemetry or analytics
âœ“ Completely standalone

## âš™ï¸ What's New in 3.1

âœ“ FIXED: Domain whitelist (subdomains/subpages now work)
âœ“ NEW: Deep crawling of search results
âœ“ NEW: Smart search URLs per domain type
âœ“ NEW: Wikipedia API integration
âœ“ NEW: Result deduplication
âœ“ IMPROVED: Parallel crawling with 4 workers

## ðŸ“– Examples

```
"sverige nyheter" â†’ News articles from SVT, DN
"hur bÃ¤ckar man fisk" â†’ Cooking guides
"vem Ã¤r greta thunberg" â†’ Wikipedia article
"mobil under 5000 kr" â†’ Product prices
"vad Ã¤r diabetes" â†’ Health info from 1177.se
```

## ðŸ”§ Troubleshooting

If executable won't run:
```bash
# Make sure it's executable
chmod +x Klar

# Run with verbose output
./Klar --verbose

# Check dependencies
ldd ./Klar
```

## ðŸ’¬ Support

- GitHub: https://github.com/CKCHDX/klar
- Issues: https://github.com/CKCHDX/klar/issues
- Contact: oscyra.solutions

EOF
    
    - name: Generate checksum
      run: |
        cd release/linux
        sha256sum Klar > Klar.SHA256.txt
        cat Klar.SHA256.txt
    
    - name: Upload Linux Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Klar-3.1-Linux-Standalone
        path: |
          release/linux/Klar
          release/linux/README.md
          release/linux/Klar.SHA256.txt
        retention-days: 90
    
    - name: Create Linux TAR.GZ
      run: |
        cd release/linux
        tar -czf ../../Klar-3.1-Linux-Standalone.tar.gz Klar README.md Klar.SHA256.txt
        ls -lh ../../Klar-3.1-Linux-Standalone.tar.gz
    
    - name: Upload Linux TAR.GZ
      uses: actions/upload-artifact@v4
      with:
        name: Klar-3.1-Linux-TAR
        path: Klar-3.1-Linux-Standalone.tar.gz
        retention-days: 90

  create-release-notes:
    name: Create Release Notes
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Generate Release Notes
      run: |
        cat > RELEASE_NOTES_3.1.md << 'EOF'
# Klar 3.1 Release Notes

**Release Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
**Status:** BETA (Ready for Testing)
**Build:** Automated via GitHub Actions

## ðŸŽ¯ Overview

Klar 3.1 is the penultimate beta release before the official Klar 1.0 consumer launch. This release focuses on:

1. **Security Fixes** - Domain whitelist now properly handles subdomains and subpages
2. **Search Quality** - Deep crawling finds actual content (articles, products) not just homepages
3. **Reliability** - Parallel crawling with proper rate limiting

## âœ¨ What's New

### ðŸ”§ Technical Improvements

#### Domain Whitelist Fix
- Fixed: Domains were being incorrectly blocked
- Fixed: Subdomains (e.g., nyheter.svt.se) didn't work
- Fixed: Subpages (e.g., svt.se/nyheter) were blocked
- Result: All 115 domains now work with subdomains and subpages

#### Deep Crawling System
- New: Smart search URL generation (25+ domain-specific templates)
- New: Parallel crawling with 4 concurrent workers
- New: Extraction of article/product links from search results
- New: Wikipedia API integration for direct article links
- New: Result deduplication
- Improved: Rate limiting (0.5s between requests per domain)

#### Crawler Enhancements
- New: Domain-specific search templates (news, shopping, Wikipedia)
- New: Result filtering and relevance checking
- Improved: Error handling and logging
- Improved: Support for subdomains

### ðŸ“Š Performance

**Search Times (Approximate):**
- Wikipedia search: 1-2 seconds
- News search: 2-3 seconds
- Shopping search: 2-3 seconds
- Multi-domain search: 3-5 seconds

**Resource Usage:**
- 4 parallel crawler threads
- ~100MB RAM cached results
- ~2-5 outbound requests per search

## ðŸ› Bug Fixes

- Fixed: "url blocked" errors for valid whitelisted domains
- Fixed: Search results only showing homepages
- Fixed: Subdomain and subpage handling
- Fixed: Domain verification logic

## ðŸ“¥ Downloads

### Windows
- `Klar-3.1-Windows-Standalone.zip` - Single executable + README
- Size: ~100MB
- Requirements: Windows 10+, 4GB RAM

### Linux
- `Klar-3.1-Linux-Standalone.tar.gz` - Single executable + README
- Size: ~110MB
- Requirements: Ubuntu 20.04+ / Debian 11+ / Fedora 35+, 4GB RAM

## ðŸ§ª Testing Checklist

### News Searches
- [ ] "sverige nyheter" â†’ Returns news articles from SVT, DN, Aftonbladet
- [ ] "stockholm" â†’ Returns news + info about Stockholm
- [ ] "senaste nyheterna" â†’ Returns recent news

### How-To Searches
- [ ] "hur bÃ¤ckar man fisk" â†’ Returns cooking guides
- [ ] "hur gÃ¶r man pannkakor" â†’ Returns recipes

### Person Lookups
- [ ] "vem Ã¤r greta thunberg" â†’ Returns Wikipedia article
- [ ] "donald trump" â†’ Returns Wikipedia + news

### Shopping Searches
- [ ] "mobil under 5000 kr" â†’ Returns products from prisjakt.nu, inet.se
- [ ] "bÃ¤sta kamera" â†’ Returns products + comparisons

### Medical Searches
- [ ] "vad Ã¤r diabetes" â†’ Returns info from 1177.se, folkhÃ¤lsomyndigheten.se
- [ ] "symptom pÃ¥ covid" â†’ Returns health information

### Wikipedia Searches
- [ ] "sverige" â†’ Returns Wikipedia article
- [ ] "stockholm sevÃ¤rdheter" â†’ Returns tourist information

## ðŸ“ Known Limitations

1. **No offline index:** Searches require internet connection
   - Future: Add LOKI offline indexing for instant searches

2. **Live crawling latency:** Searches take 2-5 seconds
   - Future: Add result caching (1 hour TTL)

3. **Limited deep crawling:** Only fetches top 10 results per page
   - Future: Increase after performance testing

4. **No knowledge panels:** Person queries don't show info cards yet
   - Future: Add knowledge panels in 1.0.2

## ðŸ”’ Security Notes

- âœ“ Only searches 115 whitelisted Swedish domains
- âœ“ No external plugins or extensions
- âœ“ No telemetry or analytics
- âœ“ No user tracking
- âœ“ All dependencies embedded
- âœ“ Cryptographic checksums provided (SHA256)

## ðŸ“‹ System Requirements

### Windows
- Windows 10 or Windows 11
- 4GB RAM minimum (8GB recommended)
- 200MB free disk space
- Internet connection

### Linux
- Ubuntu 20.04+ / Debian 11+ / Fedora 35+
- 4GB RAM minimum (8GB recommended)
- 200MB free disk space
- X11 or Wayland display server
- Internet connection

## ðŸš€ What's Next (Klar 1.0 Official)

### Critical Before Release
- [ ] User testing with 20+ non-technical Swedish users
- [ ] Fix top 10 bugs from user testing
- [ ] Performance testing under load
- [ ] Security audit

### Important (1.0.1)
- [ ] Offline index building
- [ ] 1-hour result caching
- [ ] LOKI instant answers (top 50 queries)
- [ ] THOR domain tier classification

### Nice-to-Have (1.0.2+)
- [ ] Knowledge panels for person queries
- [ ] Freshness signals for news
- [ ] Advanced filtering/facets
- [ ] User preferences

## ðŸ’¬ Feedback

This is a BETA release. Please report issues:
- GitHub Issues: https://github.com/CKCHDX/klar/issues
- Email: oscyra.solutions

## ðŸ“„ Commits

1. `fd1e71b` - Fix domain whitelist: properly handle subdomains and subpages
2. `77bdde3` - Implement deep crawling for search results
3. `87af45e` - Update crawler with smart search
4. `eb0084e` - Add comprehensive release documentation

## âœ… Version Summary

| Component | Status | Notes |
|-----------|--------|-------|
| Domain Whitelist | âœ… Fixed | All 115 domains work |
| Deep Crawling | âœ… Implemented | Smart search URLs |
| Wikipedia | âœ… Integrated | Direct article links |
| Parallel Crawling | âœ… Working | 4 concurrent workers |
| Rate Limiting | âœ… Implemented | 0.5s per domain |
| Result Dedup | âœ… Working | Removes duplicates |
| Offline Search | â³ Planned | LOKI for 1.0.1 |
| Caching | â³ Planned | 1-hour TTL for 1.0.1 |
| Instant Answers | â³ Planned | LOKI for 1.0.1 |

---

**Thank you for testing Klar 3.1!** Your feedback is crucial for the official 1.0 release.
EOF
        
        cat RELEASE_NOTES_3.1.md
    
    - name: Upload Release Notes
      uses: actions/upload-artifact@v4
      with:
        name: Release-Notes
        path: RELEASE_NOTES_3.1.md
        retention-days: 90

  summary:
    name: Build Summary
    needs: [build-windows, build-linux, create-release-notes]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Check Build Results
      run: |
        echo "ðŸŽ‰ Klar 3.1 Build Complete!"
        echo ""
        echo "ðŸ“¦ Artifacts Generated:"
        echo "  âœ“ Klar-3.1-Windows-Standalone (EXE + README + SHA256)"
        echo "  âœ“ Klar-3.1-Windows-ZIP (Compressed archive)"
        echo "  âœ“ Klar-3.1-Linux-Standalone (ELF + README + SHA256)"
        echo "  âœ“ Klar-3.1-Linux-TAR (Compressed archive)"
        echo "  âœ“ Release-Notes (RELEASE_NOTES_3.1.md)"
        echo ""
        echo "ðŸ“Š Build Status: ${{ job.status }}"
        echo ""
        echo "ðŸ”— Download from: Actions tab â†’ Artifacts"
        echo ""
        echo "Next Steps:"
        echo "  1. Download artifacts from Actions"
        echo "  2. Test with non-technical users"
        echo "  3. Report bugs on GitHub Issues"
        echo "  4. Prepare for Klar 1.0 official release"
